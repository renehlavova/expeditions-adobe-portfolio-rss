name: Deploy to Cloudflare pages.dev

on:
  pull_request:
    branches:
      - master
      - feat/**
  push:
    branches:
      - master
      - feat/**

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      CLOUDFLARE_API_TOKEN: "${{secrets.CLOUDFLARE_API_TOKEN}}"
      CLOUDFLARE_ACCOUNT_ID: a0f01e351f58a0485486acf83a4864bb

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Deploy to Pages.dev using Wrangler to branch "${{github.ref_name}}"
        run: |
          npx -y wrangler pages deploy \
            --project-name rss-expeditions-renehlavova \
            --branch "${{github.ref_name == 'master' && 'main' || github.ref_name}}" \
            .

      - name: Extract latest post GUID and trigger Make scenario
        run: |
          # Ensure rss.xml exists
          if [ ! -f rss.xml ]; then
            echo "‚ùå rss.xml not found in repo root."
            exit 1
          fi

          # Extract latest GUID and Title
          LATEST_GUID=$(grep -m1 '<guid' rss.xml | sed -E 's/.*<guid[^>]*>([^<]+)<\/guid>.*/\1/')
          LATEST_TITLE=$(grep -m1 '<title>' rss.xml | sed -E 's/.*<title>([^<]+)<\/title>.*/\1/')

          if [ -z "$LATEST_GUID" ]; then
            echo "‚ùå No <guid> found in rss.xml"
            exit 1
          fi

          echo "üöÄ Sending webhook to Make..."
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"guid\": \"${LATEST_GUID}\",\"title\":\"${LATEST_TITLE}\"}" \
            https://hook.we.make.com/upk5sipe2loms1gc0echbjz3g3qui2je \
            -w "\n‚úÖ Webhook sent with GUID: ${LATEST_GUID}\n"
